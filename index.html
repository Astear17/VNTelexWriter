<!DOCTYPE html>
<html lang="vi" class="light"> <!-- Default to light mode --><head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trình soạn thảo Telex tiếng Việt</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts for variety --><link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;700&family=Merriweather:ital,wght@0,300;0,400;0,700;1,300&family=Roboto:wght@400;700&family=Open+Sans:wght@400;700&family=Noto+Serif:wght@400;700&family=Lato:wght@400;700&family=Montserrat:wght@400;700&family=PT+Sans:wght@400;700&family=Source+Sans+Pro:wght@400;700&family=Lora:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-light: #fefefe;
            --text-light: #1e293b; /* slate-800 */
            --bg-secondary-light: #f8fafc; /* slate-50 */
            --border-light: #e2e8f0; /* slate-200 */
            --nav-bg-light: #ffffff;
            --nav-text-light: #334155; /* slate-700 */
            --placeholder-light: #94a3b8; /* slate-400 */
            --mode-toggle-on-bg: #d1fae5; /* emerald-100 */
            --mode-toggle-on-text: #059669; /* emerald-700 */
            --mode-toggle-off-bg: #e2e8f0; /* slate-200 */
            --mode-toggle-off-text: #475569; /* slate-600 */
            --copy-btn-bg: #1e293b;
            --copy-btn-hover-bg: #334155;
            --toast-bg: #1e293b;
            --toast-text: #ffffff;
            --status-bg: #f8fafc; /* slate-50 */
            --status-text: #94a3b8; /* slate-400 */
            --gradient-color: linear-gradient(108deg, #0894FF, #C959DD 34%, #FF2E54 68%, #FF9004);
            --footer-text-color: #475569; /* slate-600 */
        }

        .dark {
            --bg-light: #1a202c; /* near slate-900 */
            --text-light: #e2e8f0; /* slate-200 */
            --bg-secondary-light: #2d3748; /* near slate-800 */
            --border-light: #4a5568; /* near slate-700 */
            --nav-bg-light: #2d3748;
            --nav-text-light: #cbd5e0; /* slate-300 */
            --placeholder-light: #a0aec0; /* slate-500 */
            --mode-toggle-on-bg: #14532d; /* dark green */
            --mode-toggle-on-text: #a7f3d0; /* emerald-200 */
            --mode-toggle-off-bg: #4a5568; /* dark gray */
            --mode-toggle-off-text: #cbd5e0; /* slate-300 */
            --copy-btn-bg: #4a5568;
            --copy-btn-hover-bg: #64748b; /* slate-500 */
            --toast-bg: #4a5568;
            --toast-text: #f8fafc;
            --status-bg: #2d3748;
            --status-text: #a0aec0;
            --footer-text-color: #cbd5e0;
        }

        body {
            font-family: 'Be Vietnam Pro', sans-serif;
            background-color: var(--bg-light);
            color: var(--text-light);
            transition: background-color 0.3s, color 0.3s;
        }
        
        /* Apply dynamic colors */
        .bg-primary { background-color: var(--bg-light); }
        .text-primary { color: var(--text-light); }
        .bg-secondary { background-color: var(--bg-secondary-light); }
        .border-primary { border-color: var(--border-light); }
        .nav-bg { background-color: var(--nav-bg-light); }
        .nav-text { color: var(--nav-text-light); }
        .placeholder-text::placeholder { color: var(--placeholder-light); }
        .mode-on-bg { background-color: var(--mode-toggle-on-bg); }
        .mode-on-text { color: var(--mode-toggle-on-text); }
        .mode-off-bg { background-color: var(--mode-toggle-off-bg); }
        .mode-off-text { color: var(--mode-toggle-off-text); }
        .copy-btn-bg { background-color: var(--copy-btn-bg); }
        .copy-btn-hover-bg:hover { background-color: var(--copy-btn-hover-bg); }
        .toast-bg { background-color: var(--toast-bg); }
        .toast-text { color: var(--toast-text); }
        .status-bg { background-color: var(--status-bg); }
        .status-text { color: var(--status-text); }
        .footer-text { color: var(--footer-text-color); }

        textarea {
            resize: none;
        }
        
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: var(--bg-secondary-light);
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1; 
            border-radius: 4px;
        }
        .dark ::-webkit-scrollbar-thumb {
            background: #4a5568;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8; 
        }
        .dark ::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }

        /* Specific font styles */
        .font-roboto { font-family: 'Roboto', sans-serif; }
        .font-open-sans { font-family: 'Open Sans', sans-serif; }
        .font-noto-serif { font-family: 'Noto Serif', serif; }
        .font-lato { font-family: 'Lato', sans-serif; }
        .font-montserrat { font-family: 'Montserrat', sans-serif; }
        .font-pt-sans { font-family: 'PT Sans', sans-serif; }
        .font-source-sans-pro { font-family: 'Source Sans Pro', sans-serif; }
        .font-lora { font-family: 'Lora', serif; }
        .font-be-vietnam-pro { font-family: 'Be Vietnam Pro', sans-serif; }
        .font-merriweather { font-family: 'Merriweather', serif; }

        /* Gradient Text */
        .gradient-text {
            background: var(--gradient-color);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            color: transparent; /* Fallback for browsers not supporting -webkit-text-fill-color */
        }

        /* Gradient Border */
        .gradient-border-vn {
            border: 2px solid;
            border-image: var(--gradient-color) 1;
            padding: 4px 8px; /* For better visual */
            border-radius: 6px;
        }

        .gradient-separator {
            background: var(--gradient-color);
            height: 2px;
            width: 100%;
            margin-top: 2rem;
            margin-bottom: 1rem;
        }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden">

    <!-- Toolbar --><nav class="nav-bg border-b border-primary px-4 py-3 flex items-center justify-between shadow-sm z-10 shrink-0">
        <div class="flex items-center gap-4">
            <!-- VN Logo with gradient border --><div class="bg-[#DA251D] text-[#FFDF00] font-bold rounded p-1.5 leading-none gradient-border-vn">VN</div>
            <h1 class="font-bold text-lg nav-text gradient-text">VN Telex Writer</h1>
        </div>

        <div class="flex items-center gap-3">
            <!-- Font Selection Dropdown --><div class="relative inline-block text-left">
                <button type="button" class="inline-flex justify-center w-full rounded-md border border-primary shadow-sm px-4 py-2 bg-secondary text-sm font-medium text-primary hover:bg-slate-200 dark:hover:bg-slate-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 focus:ring-offset-slate-100 dark:focus:ring-offset-slate-800" id="font-menu-button" aria-expanded="true" aria-haspopup="true">
                    <span id="selected-font-name">Be Vietnam Pro</span>
                    <svg class="-mr-1 ml-2 h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                        <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 111.06 1.06l-4.25 4.25a.75.75 0 01-1.06 0L5.23 8.29a.75.75 0 01.02-1.06z" clip-rule="evenodd" />
                    </svg>
                </button>
                <div id="font-menu" class="origin-top-right absolute right-0 mt-2 w-56 rounded-md shadow-lg bg-nav-bg border border-primary ring-1 ring-black ring-opacity-5 focus:outline-none hidden max-h-60 overflow-y-auto" role="menu" aria-orientation="vertical" aria-labelledby="font-menu-button" tabindex="-1">
                    <div class="py-1" role="none">
                        <!-- Font options will be populated by JS --></div>
                </div>
            </div>

            <!-- Dark/Light Mode Toggle --><button onclick="toggleDarkMode()" class="px-3 py-2 rounded-lg transition-colors font-medium text-sm flex items-center gap-2 bg-secondary text-primary hover:bg-slate-200 dark:hover:bg-slate-700">
                <svg id="moon-icon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display: none;">
                    <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                </svg>
                <svg id="sun-icon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="5"></circle>
                    <line x1="12" y1="1" x2="12" y2="3"></line>
                    <line x1="12" y1="21" x2="12" y2="23"></line>
                    <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                    <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                    <line x1="1" y1="12" x2="3" y2="12"></line>
                    <line x1="21" y1="12" x2="23" y2="12"></line>
                    <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                    <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                </svg>
                <span id="dark-mode-text">Chế độ Sáng</span>
            </button>

            <!-- Telex Mode Toggle --><button onclick="toggleMode()" id="mode-toggle" class="flex items-center gap-2 px-3 py-2 rounded-lg hover:bg-emerald-200 transition-colors font-medium text-sm mode-on-bg mode-on-text">
                <span class="w-2 h-2 rounded-full bg-emerald-600" id="mode-indicator"></span>
                Telex: BẬT
            </button>

            <!-- Copy Button --><button onclick="copyText()" class="flex items-center gap-2 px-4 py-2 rounded-lg shadow-sm active:scale-95 transition-colors copy-btn-bg text-white copy-btn-hover-bg">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></svg>
                <span>Sao chép</span>
            </button>
        </div>
    </nav>

    <!-- Editor Area --><main class="flex-grow relative w-full max-w-4xl mx-auto bg-primary shadow-xl my-4 md:my-8 rounded-lg overflow-hidden flex flex-col">
        <div class="bg-primary flex-grow relative">
            <textarea 
                id="editor" 
                class="w-full h-full p-8 md:p-12 text-lg md:text-xl leading-relaxed outline-none border-none placeholder-text text-primary font-be-vietnam-pro"
                placeholder="Bắt đầu gõ tiếng Việt ở đây..."
                spellcheck="false"
            ></textarea>
            
            <!-- Success Toast --><div id="toast" class="absolute top-4 right-4 toast-bg toast-text px-4 py-2 rounded-lg shadow-lg transform transition-all duration-300 opacity-0 translate-y-[-10px] pointer-events-none">
                Đã sao chép vào khay nhớ tạm!
            </div>
        </div>

        <!-- Status Bar --><div class="status-bg border-t border-primary px-6 py-2 text-xs status-text flex justify-between">
            <span id="word-count">0 từ</span>
            <span class="hidden md:inline">Hỗ trợ Telex: aa, ee, oo, dd, aw, ow, w, s, f, r, x, j, z</span>
        </div>
    </main>

    <!-- Footer --><footer class="mt-auto px-4 py-4 text-center">
        <div class="gradient-separator mx-auto w-full max-w-4xl"></div>
        <p class="text-sm footer-text gradient-text">Triển khai và tổng hợp bởi Astear17</p>
    </footer>

    <script>
        // --- TELEX ENGINE ---
        // A lightweight, custom mapping engine for converting Telex patterns to Vietnamese
        
        const VOWELS = {
            'a': [['à','á','ả','ã','ạ'], 'ă', 'â'],
            'e': [['è','é','ẻ','ẽ','ẹ'], 'ê'],
            'o': [['ò','ó','ỏ','õ','ọ'], 'ô', 'ơ'],
            'u': [['ù','ú','ủũụ'], 'ư'],
            'i': [['ì','í','ỉ','ĩ','ị']],
            'y': [['ỳ','ý','ỷ','ỹ','ỵ']],
            'd': ['đ']
        };

        // Full Vietnamese Charset Arrays for indexing
        const CHAR_MAP = {
            'a': 'aàáảãạ',
            'ă': 'ăằắẳẵặ',
            'â': 'âầấẩẫậ',
            'e': 'eèéẻẽẹ',
            'ê': 'êềếểễệ',
            'i': 'iìíỉĩị',
            'o': 'oòóỏõọ',
            'ô': 'ôồốổỗộ',
            'ơ': 'ơờớởỡợ',
            'u': 'uùúủũụ',
            'ư': 'ưừứửữự',
            'y': 'yỳýỷỹỵ'
        };

        const TONE_MAPPING = {
            's': 1, // Sắc (Acute)
            'f': 0, // Huyền (Grave)
            'r': 2, // Hỏi (Hook)
            'x': 3, // Ngã (Tilde)
            'j': 4  // Nặng (Dot)
        };

        let isTelexEnabled = true;

        function convertWordToVietnamese(word) {
            if (!word) return word;
            
            let result = word;

            // Handle 'dd' -> 'đ'
            result = result.replace(/dd/g, 'đ').replace(/DD/g, 'Đ');

            // Handle Vowel Compounds (aa, ee, oo, aw, ow, uw)
            result = result.replace(/aa/g, 'â').replace(/AA/g, 'Â');
            result = result.replace(/ee/g, 'ê').replace(/EE/g, 'Ê');
            result = result.replace(/oo/g, 'ô').replace(/OO/g, 'Ô');
            
            result = result.replace(/aw/g, 'ă').replace(/AW/g, 'Ă');
            result = result.replace(/ow/g, 'ơ').replace(/OW/g, 'Ơ');
            result = result.replace(/uw/g, 'ư').replace(/UW/g, 'Ư');
            result = result.replace(/w/g, 'ư').replace(/W/g, 'Ư'); // standalone 'w'

            // Handle Tones (s, f, r, x, j)
            const toneKeys = Object.keys(TONE_MAPPING);
            const lastChar = result.slice(-1).toLowerCase();
            
            if (toneKeys.includes(lastChar)) {
                const toneIndex = TONE_MAPPING[lastChar]; // 0-4
                const baseWord = result.slice(0, -1); // Word without the tone key
                
                const newWord = applyTone(baseWord, toneIndex);
                
                if (newWord !== baseWord) {
                    return newWord;
                }
            }
            
            // Handle "Z" to remove tone
            if (lastChar === 'z') {
                const baseWord = result.slice(0, -1);
                return removeTone(baseWord);
            }

            return result;
        }

        function applyTone(word, toneIndex) {
            let chars = word.split('');
            let vowelIndices = [];
            
            for (let i = 0; i < chars.length; i++) {
                if (isVowel(chars[i])) {
                    vowelIndices.push(i);
                }
            }

            if (vowelIndices.length === 0) return word;

            let targetIndex = -1;

            // Simple heuristics for tone placement
            if (vowelIndices.length === 1) {
                targetIndex = vowelIndices[0];
            } else if (vowelIndices.length === 2) {
                // For diphthongs/triphthongs, usually the last 'main' vowel
                // This logic is simplified; a full IME would have more complex rules.
                targetIndex = vowelIndices[1];
                
                // Specific common exceptions for 'ia', 'ua', 'ưa' where tone is often on first vowel
                const v1Char = chars[vowelIndices[0]].toLowerCase();
                const v2Char = chars[vowelIndices[1]].toLowerCase();
                if ((v1Char === 'i' && v2Char === 'a') || (v1Char === 'u' && v2Char === 'a') || (v1Char === 'ư' && v2Char === 'a')) {
                    targetIndex = vowelIndices[0];
                }
            } else if (vowelIndices.length >= 3) {
                 targetIndex = vowelIndices[1]; // Middle vowel for triphthongs like uôi, ươi
            } else {
                targetIndex = vowelIndices[vowelIndices.length - 1]; // Fallback to last vowel
            }
            
            // Apply the tone
            if (targetIndex !== -1) {
                chars[targetIndex] = addToneToChar(chars[targetIndex], toneIndex);
            }
            
            return chars.join('');
        }

        function isVowel(char) {
            const vowels = "aăâeêioôơuưyAĂÂEÊIOÔƠUƯY";
            // Also need to check if it's an already accented vowel
            return vowels.includes(char) || getBaseVowelAndTone(char).base !== null;
        }

        function addToneToChar(char, toneIndex) {
            // Get base char (remove existing tone first)
            const { base, caseType } = getBaseVowelAndTone(char);
            if (!base) return char;

            const map = CHAR_MAP[base];
            if (!map) return char;

            // CHAR_MAP: 0 (base), 1 (grave), 2 (acute), 3 (hook), 4 (tilde), 5 (dot)
            // TONE_MAPPING: s(1), f(0), r(2), x(3), j(4)
            let mapIndex = 0;
            if (toneIndex === 0) mapIndex = 1; // f -> grave
            if (toneIndex === 1) mapIndex = 2; // s -> acute
            if (toneIndex === 2) mapIndex = 3; // r -> hook
            if (toneIndex === 3) mapIndex = 4; // x -> tilde
            if (toneIndex === 4) mapIndex = 5; // j -> dot

            let newChar = map[mapIndex];
            if (caseType === 'upper') newChar = newChar.toUpperCase();
            return newChar;
        }
        
        function removeTone(word) {
            let chars = word.split('');
            for(let i=0; i<chars.length; i++) {
                 const { base, caseType } = getBaseVowelAndTone(chars[i]);
                 if (base) {
                     chars[i] = caseType === 'upper' ? base.toUpperCase() : base;
                 }
            }
            return chars.join('');
        }

        function getBaseVowelAndTone(char) {
            const lower = char.toLowerCase();
            for (const [base, variants] of Object.entries(CHAR_MAP)) {
                if (variants.includes(lower)) {
                    return { base: base, caseType: char === lower ? 'lower' : 'upper' };
                }
            }
            return { base: null, caseType: null };
        }

        // --- DOM & INPUT HANDLING ---

        const editor = document.getElementById('editor');
        const wordCountEl = document.getElementById('word-count');
        const rootHtml = document.documentElement;

        editor.addEventListener('input', (e) => {
            if (!isTelexEnabled) {
                updateWordCount();
                return;
            }

            const cursorPosition = editor.selectionStart;
            const text = editor.value;

            const textBeforeCursor = text.slice(0, cursorPosition);
            const lastSeparatorIndex = Math.max(
                textBeforeCursor.lastIndexOf(' '), 
                textBeforeCursor.lastIndexOf('\n'),
                textBeforeCursor.lastIndexOf('\t'),
                textBeforeCursor.lastIndexOf('-'), // Consider hyphen as word break
                -1
            );
            
            const startOfWord = lastSeparatorIndex + 1;
            let wordToProcess = textBeforeCursor.slice(startOfWord);
            
            // Also consider punctuation at the end of the word (before tone mark)
            // If the word ends with a common punctuation, process word without punctuation
            const punctuationMatch = wordToProcess.match(/([.,!?;:()])$/);
            let trailingPunctuation = '';
            if (punctuationMatch) {
                trailingPunctuation = punctuationMatch[1];
                wordToProcess = wordToProcess.slice(0, -trailingPunctuation.length);
            }

            if (wordToProcess.length > 0) {
                const convertedWord = convertWordToVietnamese(wordToProcess);
                
                if (convertedWord !== wordToProcess) {
                    const textAfterCursor = text.slice(cursorPosition);
                    const newTextBeforeCursor = text.slice(0, startOfWord) + convertedWord + trailingPunctuation;
                    
                    editor.value = newTextBeforeCursor + textAfterCursor;
                    
                    // Restore cursor
                    editor.selectionStart = editor.selectionEnd = newTextBeforeCursor.length;
                }
            }
            
            updateWordCount();
        });

        function updateWordCount() {
            const text = editor.value.trim();
            const count = text ? text.split(/\s+/).length : 0;
            wordCountEl.textContent = `${count} từ`;
        }

        // --- TOOLBAR ACTIONS ---

        // Font Selection
        const fonts = [
            { name: "Be Vietnam Pro", class: "font-be-vietnam-pro" },
            { name: "Merriweather", class: "font-merriweather" },
            { name: "Roboto", class: "font-roboto" },
            { name: "Open Sans", class: "font-open-sans" },
            { name: "Noto Serif", class: "font-noto-serif" },
            { name: "Lato", class: "font-lato" },
            { name: "Montserrat", class: "font-montserrat" },
            { name: "PT Sans", class: "font-pt-sans" },
            { name: "Source Sans Pro", class: "font-source-sans-pro" },
            { name: "Lora", class: "font-lora" },
            { name: "Segoe UI", class: "font-[Segoe_UI,sans-serif]" } // System font
        ];
        
        const fontMenuButton = document.getElementById('font-menu-button');
        const fontMenu = document.getElementById('font-menu');
        const selectedFontName = document.getElementById('selected-font-name');
        let currentFontClass = "font-be-vietnam-pro"; // Default

        function populateFontMenu() {
            const menuDiv = fontMenu.querySelector('div');
            menuDiv.innerHTML = ''; // Clear existing
            fonts.forEach(font => {
                const item = document.createElement('a');
                item.href = "#";
                item.classList.add('block', 'px-4', 'py-2', 'text-sm', 'text-primary', 'hover:bg-slate-100', 'dark:hover:bg-slate-700', font.class);
                item.setAttribute('role', 'menuitem');
                item.setAttribute('tabindex', '-1');
                item.textContent = font.name;
                item.addEventListener('click', (e) => {
                    e.preventDefault();
                    setFont(font.class, font.name);
                    fontMenu.classList.add('hidden');
                });
                menuDiv.appendChild(item);
            });
        }

        function setFont(fontClass, fontName) {
            editor.classList.remove(currentFontClass);
            editor.classList.add(fontClass);
            currentFontClass = fontClass;
            selectedFontName.textContent = fontName;
        }

        fontMenuButton.addEventListener('click', () => {
            fontMenu.classList.toggle('hidden');
        });

        // Close dropdown if clicked outside
        document.addEventListener('click', (event) => {
            if (!fontMenu.contains(event.target) && !fontMenuButton.contains(event.target)) {
                fontMenu.classList.add('hidden');
            }
        });

        // Dark/Light Mode Toggle
        const moonIcon = document.getElementById('moon-icon');
        const sunIcon = document.getElementById('sun-icon');
        const darkModeText = document.getElementById('dark-mode-text');

        function toggleDarkMode() {
            if (rootHtml.classList.contains('light')) {
                rootHtml.classList.remove('light');
                rootHtml.classList.add('dark');
                localStorage.setItem('theme', 'dark');
                moonIcon.style.display = 'inline-block';
                sunIcon.style.display = 'none';
                darkModeText.textContent = 'Chế độ Tối';
            } else {
                rootHtml.classList.remove('dark');
                rootHtml.classList.add('light');
                localStorage.setItem('theme', 'light');
                moonIcon.style.display = 'none';
                sunIcon.style.display = 'inline-block';
                darkModeText.textContent = 'Chế độ Sáng';
            }
            editor.focus();
        }

        // Apply theme preference on load
        function applyThemePreference() {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                rootHtml.classList.add('dark');
                rootHtml.classList.remove('light');
                moonIcon.style.
